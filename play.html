<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Playing Game...</title>
<style>
    body, html { margin:0; padding:0; overflow:hidden; height:100%; background:#000; font-family: Arial,sans-serif; }
    #container { width:100%; height:100%; position:relative; }
    #fr { width:100%; height:calc(100% - 50px); border:none; display:block; background:#000; }
    .controls-bar { position:fixed; bottom:0; left:0; right:0; height:50px; background:rgba(15,23,42,0.95); display:flex; justify-content:space-between; align-items:center; padding:0 20px; z-index:1000; }
    .game-title { color:#fff; font-weight:bold; font-size:16px; }
    .btn-group { display:flex; gap:10px; }
    .btn { padding:8px 16px; background:#4a148c; color:#fff; border:none; border-radius:5px; font-weight:bold; cursor:pointer; transition:0.2s; }
    .btn:hover { background:#6a1b9a; }
    .btn-back { background:#333; }
    .loading-screen { position:fixed; top:0; left:0; right:0; bottom:0; background:#0f172a; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:2000; }
    .loading-spinner { width:50px; height:50px; border:4px solid rgba(255,255,255,0.2); border-top:4px solid #3b82f6; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 100% { transform:rotate(360deg); } }
    .loading-text { color:#fff; margin-top:20px; font-size:18px; }
</style>
</head>
<body>

<div id="loadingScreen" class="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Connecting to server...</div>
</div>

<div id="container">
    <iframe id="fr" allowfullscreen allow="autoplay; fullscreen; clipboard-read; clipboard-write" referrerpolicy="no-referrer"></iframe>
</div>

<div class="controls-bar">
    <span class="game-title" id="gameTitleBar">Title</span>
    <div class="btn-group">
        <button class="btn btn-back" onclick="location.href='index.html'">‚Üê Back</button>
        <button class="btn" onclick="openFullscreen()">Fullscreen</button>
    </div>
</div>

<!-- Include games.js -->
<script src="games.js"></script>
<script src="https://unpkg.com/@ruffle-rs/ruffle"></script>

<script>
    // üî• Get game ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = parseInt(urlParams.get('id'));

    // üî• Find game in GAMES array
    const currentGame = GAMES.find(g => g.id === gameId);

    if (!currentGame) {
        alert('Game not found!');
        window.location.href = 'index.html';
    } else {
        document.getElementById('gameTitleBar').textContent = currentGame.name;
        document.title = currentGame.name + " - Playing Now";
        loadGame(currentGame);
    }

    async function loadGame(game) {
        const iframe = document.getElementById('fr');
        document.getElementById('loadingText').textContent = 'Fetching game...';

        try {
            if (game.link.endsWith('.swf')) {
                loadFlash(game.link);
            } else {
                // HTML5 game
                const response = await fetch(game.link, { mode:'cors' });
                if (!response.ok) throw new Error('Failed to fetch HTML5 game');
                const html = await response.text();
                iframe.srcdoc = html;
            }
            document.getElementById('loadingScreen').style.display = 'none';
        } catch(e) {
            console.error("Game load failed:", e);
            if (game.link.endsWith('.swf')) loadFlash(game.link);
            else alert('Failed to load game!');
        }
    }

    function loadFlash(swfUrl) {
        const iframe = document.getElementById('fr');
        // ‚úÖ Properly escaped template literal
        const html = `
<!DOCTYPE html>
<html>
<head>
<style>body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#000;}#r{width:100%;height:100%;}</style>
</head>
<body>
<div id="r"></div>
<script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
<script>
window.addEventListener("load", ()=> {
    const r = window.RufflePlayer.newest();
    const p = r.createPlayer();
    document.getElementById("r").appendChild(p);
    p.load("${swfUrl}");
    p.style.width="100%";
    p.style.height="100%";
});
</script>
</body>
</html>`;
        iframe.srcdoc = html;
        document.getElementById('loadingScreen').style.display = 'none';
    }

    function openFullscreen() {
        const iframe = document.getElementById('fr');
        if (iframe.requestFullscreen) iframe.requestFullscreen();
        else if (iframe.webkitRequestFullscreen) iframe.webkitRequestFullscreen();
    }
</script>

</body>
</html>
